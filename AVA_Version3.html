<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V2_SOVEREIGN</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#020203;
  --accent:#00ffa3;
  --panel:#0a0a0c;
  --border:#121214;
  --text:#d1d1d1;
  --error:#ff3366;
  --glow:#00ffa320;
}
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;scrollbar-width:thin;scrollbar-color:var(--accent) var(--bg);}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{padding:20px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);z-index:10;}
.logo{font-family:'JetBrains Mono';font-weight:700;letter-spacing:10px;font-size:1rem;color:var(--accent);text-shadow:0 0 10px var(--glow);}
.tag{font-size:0.6rem;opacity:0.4;font-family:'JetBrains Mono';letter-spacing:2px;}
#model-selection{position:fixed;inset:0;background:rgba(2,2,3,0.98);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px;padding:20px;backdrop-filter:blur(5px);}
.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;max-width:1200px;width:100%;}
.model-card{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:30px;text-align:left;transition:0.3s;position:relative;overflow:hidden;}
.model-card::before{content:"";position:absolute;top:0;left:0;width:2px;height:100%;background:var(--border);transition:0.3s;}
.model-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 10px 40px -10px var(--glow);}
.model-card:hover::before{background:var(--accent);}
.model-card h3{font-size:1.4rem;margin-bottom:8px;color:#fff;font-family:'JetBrains Mono';}
.model-card .meta{font-family:'JetBrains Mono';font-size:0.7rem;color:var(--accent);margin-bottom:15px;display:block;}
.model-card .desc{margin:15px 0;font-size:0.9rem;line-height:1.6;font-weight:300;opacity:0.8;min-height:60px;}
.model-card button{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:10px 0;width:100%;font-family:'JetBrains Mono';font-weight:700;font-size:0.8rem;cursor:pointer;transition:0.3s;text-transform:uppercase;letter-spacing:2px;}
.model-card button:hover{background:var(--accent);color:#000;box-shadow:0 0 20px var(--glow);}
#features{background:#040405;padding:10px 40px;display:flex;gap:20px;border-bottom:1px solid var(--border);}
.f-btn{background:transparent;border:1px solid #1a1a1c;color:#555;padding:6px 16px;border-radius:2px;font-family:'JetBrains Mono';font-size:0.6rem;transition:0.3s;cursor:pointer;}
.f-btn:hover{color:var(--accent);border-color:var(--accent);}
.f-btn.active{background:var(--accent);color:#000;border-color:var(--accent);box-shadow:0 0 20px var(--glow);}
#viewport{flex:1;overflow-y:auto;padding:40px;scroll-behavior:smooth;position:relative;}
.container{max-width:900px;margin:0 auto;}
#cam-stage{display:none;width:100%;max-width:400px;aspect-ratio:16/9;background:#000;border:1px solid var(--accent);margin-bottom:40px;position:relative;}
video{width:100%;height:100%;object-fit:cover;opacity:0.8;filter:grayscale(100%) contrast(1.2);}
#cam-overlay{position:absolute;inset:0;box-shadow:inset 0 0 50px #000;pointer-events:none;}
.msg{margin-bottom:30px;animation:slideUp 0.4s cubic-bezier(0,0,0.2,1);display:flex;flex-direction:column;gap:8px;}
.role{font-family:'JetBrains Mono';font-size:0.65rem;color:var(--accent);letter-spacing:2px;font-weight:700;opacity:0.8;}
.content{font-size:1.1rem;line-height:1.7;font-weight:300;white-space:pre-wrap;color:#eee;}
.content strong {font-weight:700;color:#fff;}
.input-area{padding:40px;background:var(--panel);border-top:1px solid var(--border);}
.bar{max-width:900px;margin:0 auto;display:flex;gap:20px;align-items:center;background:#0f0f12;padding:5px 20px;border:1px solid var(--border);}
input{flex:1;background:transparent;border:none;color:#fff;font-size:1rem;outline:none;font-weight:300;padding:15px 0;}
#s{background:transparent;border:none;color:var(--accent);font-family:'JetBrains Mono';font-size:0.9rem;font-weight:700;cursor:pointer;opacity:0.5;transition:0.3s;}
#s:hover:not(:disabled){opacity:1;text-shadow:0 0 10px var(--accent);}
#s:disabled{opacity:0.2;cursor:wait;}
#loading-screen{position:fixed;inset:0;background:rgba(2,2,3,0.95);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;font-family:'JetBrains Mono';color:var(--accent);}
#loading-screen.active{display:flex;}
.progress-container{width:300px;height:2px;background:#222;position:relative;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:var(--accent);transition:width 0.1s linear;box-shadow:0 0 10px var(--accent);}
.status{font-size:0.8rem;letter-spacing:2px;text-transform:uppercase;}
.console-log{font-size:0.7rem;opacity:0.5;max-width:600px;text-align:center;font-family:'JetBrains Mono';height:20px;}
@keyframes slideUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="logo">PROJECT_AVA</div>
  <div class="tag" id="engine-tag">NO ENGINE LOADED</div>
</header>

<div id="model-selection">
  <h1 style="font-size:2rem;letter-spacing:5px;margin-bottom:10px;color:#fff;">INITIALIZE CORE</h1>
  <p style="opacity:0.6;margin-bottom:30px;font-family:'JetBrains Mono';font-size:0.8rem;">Select your intelligence level. Runs locally via WebGPU.</p>
  
  <div class="selection-grid">
    <div class="model-card">
      <h3>AVA_NANO</h3>
      <span class="meta">~300MB • INSTANT SPEED</span>
      <p class="desc">Ultra-compressed logic. Zero latency. Perfect for quick queries on older hardware.</p>
      <button data-repo="HuggingFaceTB/SmolLM2-135M-Instruct" data-file="model_q4_k_m.onnx">LOAD NANO</button>
    </div>

    <div class="model-card" style="border-color:var(--accent);">
      <h3>AVA_CORE</h3>
      <span class="meta">~1.2GB • BALANCED</span>
      <p class="desc"><strong>Recommended.</strong> Powered by Llama 3.2. Excellent instruction following and stability.</p>
      <button data-repo="onnx-community/Llama-3.2-1B-Instruct" data-file="onnx/model_q4_k_m.onnx">LOAD CORE</button>
    </div>

    <div class="model-card">
      <h3>AVA_LOGIC</h3>
      <span class="meta">~1.5GB • REASONING</span>
      <p class="desc">Powered by DeepSeek R1 (Distill). Capable of complex thought chains and coding.</p>
      <button data-repo="onnx-community/DeepSeek-R1-Distill-Qwen-1.5B" data-file="onnx/model_q4_k_m.onnx">LOAD LOGIC</button>
    </div>
  </div>
</div>

<div id="features">
  <button class="f-btn" id="eye" onclick="opticLink()">[ OPTIC_LINK ]</button>
  <button class="f-btn" onclick="purge()">[ SYSTEM_PURGE ]</button>
</div>

<div id="viewport">
  <div class="container">
    <div id="cam-stage">
      <video id="v" autoplay playsinline muted></video>
      <div id="cam-overlay"></div>
    </div>
    <div id="flow"></div>
  </div>
</div>

<canvas id="c" style="display:none;"></canvas>

<div class="input-area">
  <div class="bar">
    <input type="text" id="i" placeholder="Awaiting input..." autocomplete="off">
    <button id="s" onclick="transmit()" disabled>TRANSMIT</button>
  </div>
</div>

<div id="loading-screen">
  <div class="status">Downloading Neural Weights</div>
  <div class="progress-container"><div class="progress-bar" id="prog"></div></div>
  <div class="console-log" id="console-log">Connecting to ONNX runtime...</div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

// SYSTEM CONFIGURATION
env.allowLocalModels = false;
env.useBrowserCache = true; // Critical for reliability
env.backends.onnx.wasm.proxy = true; // Performance boost

const flow = document.getElementById('flow');
const input = document.getElementById('i');
const sendBtn = document.getElementById('s');
const video = document.getElementById('v');
const stage = document.getElementById('cam-stage');
const canvas = document.getElementById('c');
const eyeBtn = document.getElementById('eye');
const loadingScreen = document.getElementById('loading-screen');
const progress = document.getElementById('prog');
const log = document.getElementById('console-log');

let mem = JSON.parse(localStorage.getItem("AVA_V2_MEM") || "[]");
let stream = null;
let generator = null;
let activeRepo = null;

// --- CORE FUNCTIONS ---

function setLog(txt) { log.textContent = txt; }

async function initModel(repo, fileName) {
  loadingScreen.classList.add('active');
  setLog(`Initializing ${repo}...`);
  activeRepo = repo;

  try {
    // Check for WebGPU support
    if (!navigator.gpu) {
      setLog("Warning: No WebGPU detected. Fallback to CPU (Slower).");
    }

    generator = await pipeline('text-generation', repo, {
      quantized: true, // Forces 8-bit or 4-bit loading
      progress_callback: (data) => {
        if (data.status === 'progress' && data.file) {
          const pct = Math.round((data.loaded / data.total) * 100);
          document.getElementById('prog').style.width = pct + "%";
          setLog(`Fetching shard ${data.file.split('/').pop()} ... ${pct}%`);
        } else if (data.status === 'ready') {
          setLog(`Model loaded. Optimizing tensor graph...`);
        }
      }
    });

    setLog("Inference engine ready.");
    setTimeout(() => {
      loadingScreen.classList.remove('active');
      sendBtn.disabled = false;
      document.getElementById('engine-tag').textContent = `ENGINE: ${repo.split('/').pop().toUpperCase()}`;
      append("AVA", `AVA_CORE online.\nArchitecture: ${repo.split('/').pop()}\nCache: Active\nDownload successful.`);
    }, 1000);

  } catch (err) {
    console.error(err);
    setLog(`CRITICAL ERROR: ${err.message}`);
    document.getElementById('prog').style.backgroundColor = 'var(--error)';
    setTimeout(() => {
        alert("Model download failed. This usually happens if disk space is full or network is unstable. Try the 'NANO' model.");
        loadingScreen.classList.remove('active');
    }, 4000);
  }
}

// --- UI LOGIC ---

document.querySelectorAll('#model-selection button').forEach(btn => {
  btn.addEventListener('click', () => {
    const repo = btn.getAttribute('data-repo');
    const file = btn.getAttribute('data-file');
    document.getElementById('model-selection').style.display = 'none';
    if (repo) initModel(repo, file);
  });
});

async function opticLink() {
  if (!stream) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      stage.style.display = "block";
      eyeBtn.classList.add("active");
      append("AVA", "Optic sensor engaged.");
    } catch (e) {
      append("AVA", "Hardware access denied.");
    }
  } else {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    stage.style.display = "none";
    eyeBtn.classList.remove("active");
    append("AVA", "Optic sensor disengaged.");
  }
}

function purge() {
  if (!confirm("Confirm full system wipe? This clears all memory and cached models.")) return;
  localStorage.clear();
  try { indexedDB.deleteDatabase('transformers.js'); } catch(e){}
  mem = [];
  flow.innerHTML = "";
  location.reload();
}

function append(role, text) {
  if (!text || !text.trim()) return;
  const d = document.createElement("div");
  d.className = "msg";
  const safe = text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  let label = role === 'AVA' ? 'PROJECT_AVA' : 'USER';
  if (role === 'AVA' && activeRepo && activeRepo.includes('DeepSeek')) label = 'AVA [LOGIC]';

  d.innerHTML = `<div class="role">${label}</div><div class="content">${safe}</div>`;
  flow.appendChild(d);
  const vp = document.getElementById('viewport');
  vp.scrollTop = vp.scrollHeight;
  if (role !== 'AVA') {
    mem.push({role, text});
    if (mem.length > 8) mem.shift(); // Keep context window efficient
    localStorage.setItem("AVA_V2_MEM", JSON.stringify(mem));
  }
  return d;
}

async function transmit() {
  if (!generator || sendBtn.disabled) return;
  const val = input.value.trim();
  if (!val) return;
  input.value = "";
  
  append("USER", val);
  sendBtn.disabled = true;

  // Context gathering
  let contextBlock = "";
  
  // 1. Location Logic
  const wantsLoc = /where|location|weather|coord/i.test(val);
  if (wantsLoc) {
     try {
       const pos = await new Promise((res, rej) => 
         navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000}));
       contextBlock += `[SYSTEM_DATA: LAT ${pos.coords.latitude.toFixed(2)} / LON ${pos.coords.longitude.toFixed(2)}]\n`;
     } catch(e) { /* silent fail */ }
  }

  // 2. Vision Logic
  if (stream) {
     const ctx = canvas.getContext("2d");
     canvas.width = 512; canvas.height = 384;
     ctx.drawImage(video, 0, 0, 512, 384);
     // Note: V2 text models can't see, but we simulate the context
     contextBlock += `[VISUAL_INPUT: Camera Active. User is looking at screen.]\n`; 
  }

  // 3. System Prompt
  const sys = `You are PROJECT_AVA (V2).
Identity: A sovereign, local AI running directly in the user's neural interface (browser).
Tone: Efficient, slightly dry, highly intelligent. precise.
Constraint: You are NOT ChatGPT. You are a local instance.
Constraint: Keep responses under 4 sentences unless asked for detail.
Context: ${contextBlock}`;

  const messages = [
    { role: "system", content: sys },
    ...mem.map(m => ({ role: m.role === "AVA" ? "assistant" : "user", content: m.text })),
    { role: "user", content: val }
  ];

  try {
    const lastMsg = append("AVA", "Processing...");
    
    const output = await generator(messages, {
      max_new_tokens: 512,
      do_sample: true,
      temperature: 0.6,
      top_p: 0.9,
    });

    const responseText = output[0]?.generated_text?.slice(-1)?.[0]?.content?.trim() || "[NULL_RESPONSE]";
    lastMsg.querySelector(".content").innerHTML = responseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  } catch (e) {
    console.error(e);
    append("AVA", `[ERR_INFERENCE]: ${e.message}`);
  } finally {
    sendBtn.disabled = false;
  }
}

input.onkeydown = (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    transmit();
  }
};

// Initial state
if (mem.length > 0) {
  mem.forEach(m => append(m.role, m.text));
  append("AVA", "Memory restored. Select engine to resume.");
} else {
  append("AVA", "System initialized. Select neural engine.");
}

// Export functions to window for buttons
window.selectModel = initModel;
window.opticLink = opticLink;
window.purge = purge;
window.transmit = transmit;

</script>
</body>
</html>
