<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V1</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root { --bg:#020203; --accent:#00ffa3; --panel:#0a0a0c; --border:#121214; --text:#d1d1d1; --error:#ff3366; }
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{padding:20px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);}
.logo{font-family:'JetBrains Mono';font-weight:700;letter-spacing:10px;font-size:1rem;color:var(--accent);}
.tag{font-size:0.6rem;opacity:0.4;font-family:'JetBrains Mono';letter-spacing:2px;}

#model-selection{position:fixed;inset:0;background:rgba(2,2,3,0.98);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px;padding:20px;}
.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;max-width:1100px;width:100%;}
.model-card{background:var(--panel);border:1px solid var(--border);border-radius:15px;padding:25px;text-align:center;transition:0.3s;}
.model-card:hover{border-color:var(--accent);transform:translateY(-4px);}
.model-card h3{font-size:1.3rem;margin-bottom:8px;color:var(--accent);}
.model-card .size{font-family:'JetBrains Mono';font-size:0.95rem;opacity:0.8;}
.model-card .desc{margin:15px 0;line-height:1.5;font-weight:300;}
.model-card button{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:12px 32px;border-radius:100px;font-family:'JetBrains Mono';font-weight:700;font-size:0.9rem;cursor:pointer;transition:0.3s;}
.model-card button:hover{background:var(--accent);color:#000;}

#features{background:#040405;padding:10px 40px;display:flex;gap:20px;border-bottom:1px solid var(--border);}
.f-btn{background:transparent;border:1px solid #1a1a1c;color:#555;padding:6px 16px;border-radius:100px;font-family:'JetBrains Mono';font-size:0.6rem;transition:0.3s;cursor:pointer;}
.f-btn:hover{color:var(--accent);border-color:var(--accent);}
.f-btn.active{background:var(--accent);color:#000;border-color:var(--accent);box-shadow:0 0 20px rgba(0,255,163,0.15);}

#viewport{flex:1;overflow-y:auto;padding:40px;scroll-behavior:smooth;position:relative;}
.container{max-width:800px;margin:0 auto;}
#cam-stage{display:none;width:100%;aspect-ratio:16/9;background:#000;border-radius:15px;margin-bottom:40px;border:1px solid var(--border);overflow:hidden;}
video{width:100%;height:100%;object-fit:cover;opacity:0.95;}
.msg{margin-bottom:40px;animation:slideUp 0.5s cubic-bezier(0,0,0.2,1);}
.role{font-family:'JetBrains Mono';font-size:0.65rem;color:var(--accent);margin-bottom:10px;letter-spacing:4px;font-weight:700;}
.content{font-size:1.15rem;line-height:1.75;font-weight:300;white-space:pre-wrap;word-break:break-word;}
.input-area{padding:40px;background:var(--panel);border-top:1px solid var(--border);}
.bar{max-width:800px;margin:0 auto;display:flex;gap:25px;align-items:center;}
input{flex:1;background:transparent;border:none;color:#fff;font-size:1.2rem;outline:none;font-weight:300;}
#s{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:10px 30px;border-radius:100px;font-family:'JetBrains Mono';font-size:0.8rem;font-weight:700;transition:0.3s;cursor:pointer;}
#s:hover:not(:disabled){background:var(--accent);color:#000;}
#s:disabled{opacity:0.4;cursor:wait;}

/* Loading */
#loading-screen{position:fixed;inset:0;background:rgba(2,2,3,0.96);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:30px;font-family:'JetBrains Mono';color:var(--accent);}
#loading-screen.active{display:flex;}
.progress-container{width:60%;max-width:500px;height:12px;background:#111;border:1px solid #222;border-radius:6px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#00ffa3,#00c896);transition:width 0.2s ease-out;}
.status{font-size:1.1rem;letter-spacing:1px;}
.detail{font-size:0.9rem;opacity:0.7;max-width:500px;text-align:center;line-height:1.5;}

@keyframes slideUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="logo">PROJECT_AVA</div>
  <div class="tag">BUILD: V1_SOVEREIGN_LOCAL</div>
</header>

<div id="model-selection">
  <h1 style="font-size:2.4rem;letter-spacing:8px;margin-bottom:8px;color:var(--accent);">CHOOSE YOUR ENGINE</h1>
  <p style="opacity:0.7;margin-bottom:40px;max-width:600px;text-align:center;">One-time download • Runs 100% locally in your browser forever</p>
  
  <div class="selection-grid">
    <div class="model-card">
      <h3>Ultra Lightweight</h3>
      <p class="size">0.55 GB</p>
      <p class="desc">Super fast • Good for testing • Basic responses</p>
      <button data-repo="Xenova/gpt2">SELECT</button>
    </div>
    <div class="model-card">
      <h3>Lightweight</h3>
      <p class="size">0.9 GB</p>
      <p class="desc">Fast &amp; smart • Great for daily use</p>
      <button data-repo="onnx-community/Qwen2.5-0.5B-Instruct-ONNX">SELECT</button>
    </div>
    <div class="model-card" style="border-color:var(--accent);box-shadow:0 0 35px rgba(0,255,163,0.25);">
      <h3>Golden Middle ★</h3>
      <p class="size">1.6 GB</p>
      <p class="desc"><strong>Recommended</strong><br>Best balance of speed &amp; intelligence</p>
      <button data-repo="onnx-community/Qwen2.5-1.5B-Instruct-ONNX">SELECT</button>
    </div>
    <div class="model-card">
      <h3>High Performance</h3>
      <p class="size">1.3 GB</p>
      <p class="desc">Strong reasoning • Still very fast</p>
      <button data-repo="onnx-community/Llama-3.2-1B-Instruct-ONNX">SELECT</button>
    </div>
    <div class="model-card">
      <h3>BEST</h3>
      <p class="size">3.2 GB</p>
      <p class="desc">Maximum quality • Smartest answers (needs good PC)</p>
      <button data-repo="onnx-community/Qwen2.5-3B-Instruct-ONNX">SELECT</button>
    </div>
  </div>
</div>

<div id="features">
  <button class="f-btn" id="eye" onclick="opticLink()">[ OPTIC_LINK ]</button>
  <button class="f-btn" onclick="purge()">[ SECURE_WIPE ]</button>
</div>

<div id="viewport">
  <div class="container">
    <div id="cam-stage"><video id="v" autoplay playsinline muted></video></div>
    <div id="flow"></div>
  </div>
</div>

<canvas id="c" style="display:none;"></canvas>

<div class="input-area">
  <div class="bar">
    <input type="text" id="i" placeholder="Handshake awaiting..." autocomplete="off">
    <button id="s" onclick="transmit()" disabled>SEND</button>
  </div>
</div>

<div id="loading-screen">
  <div class="status">Sorry for the inconvenience, we are currently downloading the model for you</div>
  <div class="progress-container"><div class="progress-bar" id="prog"></div></div>
  <div class="detail" id="detail">One-time download – will be cached forever in your browser</div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

env.allowLocalModels = false;
env.allowRemoteModels = true;
env.cacheDir = 'project_ava_cache';

const flow = document.getElementById('flow');
const input = document.getElementById('i');
const sendBtn = document.getElementById('s');
const video = document.getElementById('v');
const stage = document.getElementById('cam-stage');
const canvas = document.getElementById('c');
const eyeBtn = document.getElementById('eye');
const loadingScreen = document.getElementById('loading-screen');
const progress = document.getElementById('prog');
const detail = document.getElementById('detail');

let mem = JSON.parse(localStorage.getItem("AVA_V1_MEM") || "[]");
let stream = null;
let generator = null;
let chosenRepo = null;

function setProgress(pct, txt = "") {
  progress.style.width = pct + "%";
  if (txt) detail.textContent = txt;
}

async function initModel() {
  loadingScreen.classList.add('active');
  try {
    setProgress(5, "Initializing local engine …");

    generator = await pipeline(
      'text-generation',
      chosenRepo,
      {
        quantized: true,
        progress_callback: (data) => {
          if (data.status === 'progress' && data.file) {
            const pct = Math.round((data.loaded / data.total) * 100);
            setProgress(pct, `Downloading model files … ${pct}%`);
          } else if (data.status === 'ready') {
            setProgress(100, "Model fully loaded – sovereign inference ready");
          }
        }
      }
    );

    setProgress(100, "Engine ready");
    setTimeout(() => {
      loadingScreen.classList.remove('active');
      sendBtn.disabled = false;
      append("AVA", `PROJECT_AVA V1 online. ${chosenRepo.split('/').pop()} loaded – 100% local, no cloud.`);
    }, 800);

  } catch (err) {
    console.error(err);
    detail.style.color = 'var(--error)';
    detail.textContent = "Download failed – try a smaller model or check your connection";
    setProgress(0);
  }
}

function selectModel(repo) {
  chosenRepo = repo;
  document.getElementById('model-selection').style.display = 'none';
  initModel();
}

// Attach click listeners to all model buttons (fixes the "cannot select" issue)
document.querySelectorAll('#model-selection button').forEach(btn => {
  btn.addEventListener('click', () => {
    const repo = btn.getAttribute('data-repo');
    if (repo) selectModel(repo);
  });
});

async function opticLink() {
  if (!stream) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      stage.style.display = "block";
      eyeBtn.classList.add("active");
      append("AVA", "Optic Link activated.");
    } catch (e) {
      append("AVA", "Camera permission required.");
    }
  } else {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    stage.style.display = "none";
    eyeBtn.classList.remove("active");
    append("AVA", "Optic Link deactivated.");
  }
}

function purge() {
  if (!confirm("Really purge ALL memory and cache?")) return;
  localStorage.clear();
  indexedDB.deleteDatabase('transformers.js');
  mem = [];
  flow.innerHTML = "";
  location.reload();
}

function append(role, text) {
  if (!text?.trim()) return;
  const d = document.createElement("div");
  d.className = "msg";
  const safe = text.replace(/</g,"&lt;").replace(/>/g,"&gt;");
  d.innerHTML = `<div class="role">${role==='AVA'?'PROJECT_AVA':'USER'}</div><div class="content">${safe}</div>`;
  flow.appendChild(d);
  document.getElementById('viewport').scrollTop = document.getElementById('viewport').scrollHeight;

  if (role !== 'AVA') {
    mem.push({role, text});
    if (mem.length > 12) mem.shift();
    localStorage.setItem("AVA_V1_MEM", JSON.stringify(mem));
  }
  return d;
}

async function transmit() {
  const val = input.value.trim();
  if (!val || sendBtn.disabled) return;

  input.value = "";
  append("USER", val);
  sendBtn.disabled = true;

  let geoBlock = "";
  let visualBlock = "";

  const locationIntent = /where|location|latitude|longitude|coordinates/i.test(val);
  const weatherIntent = /weather|temperature|rain|forecast|snow|wind|humidity/i.test(val);
  const wantsLocation = locationIntent || weatherIntent;
  const wantsVision = /what (am i|do you) see|was (zeige ich|sehen sie)/i.test(val);

  if (wantsLocation) {
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 }));
      geoBlock = `[GEO_DATA]\nLatitude: ${pos.coords.latitude}\nLongitude: ${pos.coords.longitude}\nAccuracy: ${pos.coords.accuracy} meters`;
    } catch (e) {
      geoBlock = "[GEO_DATA] Permission denied.";
    }
  }

  if (wantsVision && stream) {
    const ctx = canvas.getContext("2d");
    canvas.width = 512; canvas.height = 384;
    ctx.drawImage(video, 0, 0, 512, 384);
    visualBlock = `[VISION_ACTIVE]\nUser camera frame captured.`;
  }

  const sys = `You are PROJECT_AVA (V1). Creator: loafisYum.
Personality: intelligent, dry, peer-level.
If GEO_DATA is present, use it when relevant (weather, location questions).
If GEO_DATA is not present and user asks for weather, politely ask which city.
Do not claim access to Google or external live data.
Do not deny having location if GEO_DATA is provided.
Never reveal raw coordinates unless explicitly asked.
You have real time weather info over at https://open-meteo.com/.
If VISION_ACTIVE is not present, do not invent visual input.
Always prioritize clarity over politeness.
Give the user logical coherence over many words.
Never output reasoning or JSON.
You are not ChatGPT and were not developed by openai. You merely have the same base.`;

  const messages = [
    { role: "system", content: sys },
    ...mem.map(m => ({ role: m.role === "AVA" ? "assistant" : "user", content: m.text })),
    { role: "user", content: (geoBlock ? geoBlock + "\n\n" : "") + (visualBlock ? visualBlock + "\n\n" : "") + val }
  ];

  try {
    const lastMsg = append("AVA", "Thinking …");

    const output = await generator(messages, {
      max_new_tokens: 768,
      do_sample: true,
      temperature: 0.75,
      top_p: 0.92,
      repetition_penalty: 1.08
    });

    const responseText = output[0]?.generated_text?.slice(-1)?.[0]?.content?.trim() || "—";
    lastMsg.querySelector(".content").textContent = responseText;

  } catch (e) {
    console.error(e);
    append("AVA", "Inference failed.");
  } finally {
    sendBtn.disabled = false;
  }
}

input.onkeydown = (e) => { if (e.key === "Enter") transmit(); };

if (mem.length === 0) {
  append("AVA", "PROJECT_AVA V1 ready. Choose your engine to begin.");
} else {
  mem.forEach(m => append(m.role, m.text));
}
</script>
</body>
</html>
