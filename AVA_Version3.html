<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V1</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #020203;
  --accent: #00ffa3;
  --panel: #0a0a0c;
  --border: #121214;
  --text: #d1d1d1;
  --error: #ff3366;
  --glow: #00ffa340;
}
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Outfit',sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  position:relative;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:linear-gradient(rgba(0,255,163,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,163,0.025) 1px,transparent 1px);
  background-size:50px 50px;
  pointer-events:none;
  z-index:-1;
  animation:gridMove 60s linear infinite;
}
@keyframes gridMove{0%{background-position:0 0}100%{background-position:50px 50px}}

header{
  padding:22px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  z-index:10;
}
.logo{
  font-family:'JetBrains Mono';
  font-weight:700;
  letter-spacing:12px;
  font-size:1.15rem;
  color:var(--accent);
  text-shadow:0 0 20px var(--glow);
}
.tag{font-size:0.65rem;opacity:0.45;font-family:'JetBrains Mono';letter-spacing:3px;}

#model-selection{
  position:fixed;
  inset:0;
  background:rgba(2,2,3,0.99);
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:40px;
  padding:30px;
}
.selection-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(290px,1fr));
  gap:28px;
  max-width:1250px;
  width:100%;
}
.model-card{
  background:var(--panel);
  border:2px solid var(--border);
  border-radius:20px;
  padding:32px 28px;
  text-align:center;
  transition:0.5s cubic-bezier(0.23,1,0.32,1);
  cursor:pointer;
}
.model-card:hover{
  border-color:var(--accent);
  transform:translateY(-14px) scale(1.04);
  box-shadow:0 0 70px var(--glow);
}
.model-card h3{
  font-size:1.5rem;
  margin-bottom:12px;
  color:var(--accent);
  letter-spacing:2px;
}
.model-card .size{
  font-family:'JetBrains Mono';
  font-size:1.05rem;
  color:#00ffa380;
  margin-bottom:18px;
}
.model-card .desc{
  line-height:1.6;
  font-weight:300;
  min-height:88px;
}
.model-card button{
  background:transparent;
  border:2px solid var(--accent);
  color:var(--accent);
  padding:15px 42px;
  border-radius:999px;
  font-family:'JetBrains Mono';
  font-weight:700;
  font-size:0.95rem;
  cursor:pointer;
  margin-top:25px;
  transition:0.4s;
}
.model-card button:hover{
  background:var(--accent);
  color:#000;
  box-shadow:0 0 40px var(--glow);
}

#features{
  background:#040405;
  padding:14px 40px;
  display:flex;
  gap:22px;
  border-bottom:1px solid var(--border);
}
.f-btn{
  background:transparent;
  border:1px solid #1a1a1c;
  color:#555;
  padding:9px 22px;
  border-radius:999px;
  font-family:'JetBrains Mono';
  font-size:0.65rem;
  transition:0.3s;
  cursor:pointer;
}
.f-btn:hover{color:var(--accent);border-color:var(--accent);}
.f-btn.active{color:var(--accent);border-color:var(--accent);box-shadow:0 0 10px var(--glow);}

#viewport{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  padding:40px 40px 20px;
  scroll-behavior:smooth;
  position:relative;
}
.container{max-width:860px;margin:0 auto;}

#cam-stage{
  display:none;
  width:100%;
  aspect-ratio:16/9;
  background:#000;
  border-radius:20px;
  margin-bottom:45px;
  border:2px solid var(--border);
  overflow:hidden;
  box-shadow:0 0 50px rgba(0,255,163,0.2);
}
video{width:100%;height:100%;object-fit:cover;opacity:0.96;}

.msg{
  margin-bottom:48px;
  animation:slideUp 0.6s cubic-bezier(0.23,1,0.32,1);
}
.role{
  font-family:'JetBrains Mono';
  font-size:0.7rem;
  color:var(--accent);
  margin-bottom:9px;
  letter-spacing:5px;
  font-weight:700;
}
.content{
  font-size:1.2rem;
  line-height:1.8;
  font-weight:300;
  white-space:pre-wrap;
  word-break:break-word;
}

.input-area{
  padding:38px 40px;
  background:var(--panel);
  border-top:1px solid var(--border);
}
.bar{
  max-width:860px;
  margin:0 auto;
  display:flex;
  gap:28px;
  align-items:center;
}
input{
  flex:1;
  background:transparent;
  border:none;
  color:#fff;
  font-size:1.28rem;
  outline:none;
  font-weight:300;
}
#s{
  background:transparent;
  border:2px solid var(--accent);
  color:var(--accent);
  padding:13px 40px;
  border-radius:999px;
  font-family:'JetBrains Mono';
  font-size:0.88rem;
  font-weight:700;
  transition:0.4s;
  cursor:pointer;
}
#s:hover:not(:disabled){
  background:var(--accent);
  color:#000;
  box-shadow:0 0 45px var(--glow);
}
#s:disabled{opacity:0.4;cursor:not-allowed;}

#loading-screen{
  position:fixed;
  inset:0;
  background:rgba(2,2,3,0.99);
  z-index:99999;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:45px;
  font-family:'JetBrains Mono';
  color:var(--accent);
}
#loading-screen.active{display:flex;}
.loading-glow{
  width:360px;
  height:360px;
  background:radial-gradient(circle,#00ffa340 15%,transparent 75%);
  border-radius:50%;
  animation:loadingGlow 4.5s ease-in-out infinite alternate;
  filter:blur(25px);
}
@keyframes loadingGlow{0%{transform:scale(0.7);opacity:0.6;}100%{transform:scale(1.35);opacity:0.9;}}
.progress-container{
  width:66%;
  max-width:580px;
  height:17px;
  background:#111;
  border:1px solid #222;
  border-radius:999px;
  overflow:hidden;
  box-shadow:0 0 30px var(--glow);
}
.progress-bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#00ffa3,#00ffdd,#00ffa3);
  background-size:400% 100%;
  animation:shimmer 2.2s linear infinite;
  transition:width 0.25s ease-out;
}
@keyframes shimmer{0%{background-position:-400% 0}100%{background-position:400% 0}}
.status{
  font-size:1.3rem;
  letter-spacing:4px;
  position:relative;
}
.status::after{content:"…";animation:dotPulse 1.5s infinite;}
.detail{
  font-size:0.96rem;
  opacity:0.8;
  max-width:540px;
  text-align:center;
  line-height:1.7;
}
@keyframes dotPulse{0%,100%{opacity:0.3}50%{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(35px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="logo">PROJECT_AVA</div>
  <div class="tag">BUILD: V1_SOVEREIGN_LOCAL</div>
</header>

<div id="model-selection">
  <h1 style="font-size:2.8rem;letter-spacing:12px;color:var(--accent);">SELECT CORE</h1>
  <p style="opacity:0.65;max-width:640px;text-align:center;">One-time download • 100% local forever</p>
  <div class="selection-grid">
    <div class="model-card" onclick="selectModel('Xenova/gpt2')">
      <h3>ULTRA LIGHT</h3>
      <p class="size">0.55 GB</p>
      <p class="desc">Instant speed • Test mode</p>
      <button>ACTIVATE</button>
    </div>
    <div class="model-card" onclick="selectModel('onnx-community/Qwen2.5-0.5B-Instruct-ONNX')">
      <h3>LIGHTWEIGHT</h3>
      <p class="size">0.9 GB</p>
      <p class="desc">Fast daily driver</p>
      <button>ACTIVATE</button>
    </div>
    <div class="model-card" style="border-color:var(--accent);box-shadow:0 0 60px var(--glow);" onclick="selectModel('onnx-community/Qwen2.5-1.5B-Instruct-ONNX')">
      <h3>GOLDEN MIDDLE ★</h3>
      <p class="size">1.6 GB</p>
      <p class="desc"><strong>RECOMMENDED</strong><br>Perfect balance</p>
      <button>ACTIVATE</button>
    </div>
    <div class="model-card" onclick="selectModel('onnx-community/Llama-3.2-1B-Instruct-ONNX')">
      <h3>HIGH PERF</h3>
      <p class="size">1.3 GB</p>
      <p class="desc">Strong reasoning</p>
      <button>ACTIVATE</button>
    </div>
    <div class="model-card" onclick="selectModel('onnx-community/Qwen2.5-3B-Instruct-ONNX')">
      <h3>MAXIMUM</h3>
      <p class="size">3.2 GB</p>
      <p class="desc">Smartest answers</p>
      <button>ACTIVATE</button>
    </div>
  </div>
</div>

<div id="features">
  <button class="f-btn" id="eye" onclick="opticLink()">[ OPTIC_LINK ]</button>
  <button class="f-btn" onclick="purge()">[ SECURE_WIPE ]</button>
</div>

<div id="viewport">
  <div class="container">
    <div id="cam-stage"><video id="v" autoplay playsinline muted></video></div>
    <div id="flow"></div>
  </div>
</div>

<canvas id="c" style="display:none;"></canvas>

<div class="input-area">
  <div class="bar">
    <input type="text" id="i" placeholder="Handshake awaiting..." autocomplete="off">
    <button id="s" onclick="transmit()" disabled>SEND</button>
  </div>
</div>

<div id="loading-screen">
  <div class="loading-glow"></div>
  <div class="status">Downloading sovereign core</div>
  <div class="progress-container"><div class="progress-bar" id="prog"></div></div>
  <div class="detail" id="detail">One-time download. Everything stays on your device.</div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

// 1. Core Configuration
env.allowLocalModels = false;
env.allowRemoteModels = true;
env.cacheDir = 'project_ava_cache';

const flow = document.getElementById('flow');
const input = document.getElementById('i');
const sendBtn = document.getElementById('s');
const video = document.getElementById('v');
const stage = document.getElementById('cam-stage');
const canvas = document.getElementById('c');
const eyeBtn = document.getElementById('eye');
const loadingScreen = document.getElementById('loading-screen');
const progress = document.getElementById('prog');
const detail = document.getElementById('detail');

let mem = JSON.parse(localStorage.getItem("AVA_V1_MEM") || "[]");
let stream = null;
let generator = null;
let chosenRepo = null;

function setProgress(pct, txt = "") {
  progress.style.width = pct + "%";
  if (txt) detail.textContent = txt;
}

// FIX: Functions must be attached to 'window' to work with HTML 'onclick'
window.selectModel = (repo) => {
  chosenRepo = repo;
  document.getElementById('model-selection').style.display = 'none';
  initModel();
};

async function initModel() {
  loadingScreen.classList.add('active');
  setProgress(5, "Initializing sovereign core…");
  try {
    generator = await pipeline('text-generation', chosenRepo, {
      quantized: true,
      progress_callback: (data) => {
        if (data.status === 'progress' && data.file) {
          const pct = Math.round((data.loaded / data.total) * 100);
          setProgress(pct, `Downloading ${data.file.split('/').pop()} … ${pct}%`);
        }
      }
    });
    setProgress(100, "Core active.");
    setTimeout(() => {
      loadingScreen.classList.remove('active');
      sendBtn.disabled = false;
      if (mem.length === 0) {
          append("AVA", `PROJECT_AVA V1 online. ${chosenRepo.split('/').pop()} loaded.`);
      }
    }, 900);
  } catch (err) {
    console.error(err);
    detail.style.color = 'var(--error)';
    detail.textContent = "Initialization failed.";
  }
}

window.opticLink = async () => {
  if (!stream) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      stage.style.display = "block";
      eyeBtn.classList.add("active");
    } catch (e) { append("AVA", "Camera denied."); }
  } else {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    stage.style.display = "none";
    eyeBtn.classList.remove("active");
  }
};

window.purge = () => {
  if (!confirm("PURGE ALL MEMORY?")) return;
  localStorage.clear();
  indexedDB.deleteDatabase('transformers.js');
  location.reload();
};

function append(role, text) {
  if (!text) return;
  const d = document.createElement("div");
  d.className = "msg";
  const safe = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
  d.innerHTML = `<div class="role">${role === 'AVA' ? 'PROJECT_AVA' : 'USER'}</div><div class="content">${safe}</div>`;
  flow.appendChild(d);
  const vp = document.getElementById('viewport');
  vp.scrollTop = vp.scrollHeight;
  return d;
}

// FIX: Explicitly attached to window and added 'return_full_text: false'
window.transmit = async () => {
  if (!generator || sendBtn.disabled) return;
  const val = input.value.trim();
  if (!val) return;
  
  input.value = "";
  append("USER", val);
  mem.push({ role: "USER", text: val });
  
  sendBtn.disabled = true;
  const sys = `You are PROJECT_AVA (V1). Personality: intelligent, dry. You are a local AI.`;

  const messages = [
    { role: "system", content: sys },
    ...mem.map(m => ({ role: m.role === "AVA" ? "assistant" : "user", content: m.text })),
    { role: "user", content: val }
  ];

  try {
    const last = append("AVA", "Thinking …");
    
    const out = await generator(messages, { 
        max_new_tokens: 512, 
        do_sample: true, 
        temperature: 0.7,
        return_full_text: false // Stops AVA from repeating the user prompt
    });

    let resp = out[0].generated_text.trim();
    last.querySelector(".content").textContent = resp;
    
    mem.push({ role: "AVA", text: resp });
    if (mem.length > 15) mem.shift();
    localStorage.setItem("AVA_V1_MEM", JSON.stringify(mem));

  } catch (e) {
    console.error(e);
    append("AVA", "Inference error.");
  } finally {
    sendBtn.disabled = false;
  }
};

// FIX: Properly handle the Enter key
input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        window.transmit();
    }
});

// Restore session
if (mem.length > 0) {
  mem.forEach(m => append(m.role, m.text));
} else {
  append("AVA", "PROJECT_AVA V1 ready. Choose your core.");
}
</script>
</body>
</html>
