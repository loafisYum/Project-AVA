<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V1.2</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#020203;--accent:#00ffa3;--panel:#0a0a0c;--border:#121214;--text:#d1d1d1;--glow:#00ffa340;
}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;margin:0;}
header{padding:22px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);z-index:10;}
.logo{font-family:'JetBrains Mono';font-weight:700;letter-spacing:12px;font-size:1.15rem;color:var(--accent);text-shadow:0 0 20px var(--glow);}
.tag{font-size:0.65rem;opacity:0.45;font-family:'JetBrains Mono';letter-spacing:3px;}
#viewport{flex:1 1 auto;overflow-y:auto;padding:20px;scroll-behavior:smooth;}
.msg{margin-bottom:25px;}
.role{font-family:'JetBrains Mono';font-size:0.7rem;color:var(--accent);margin-bottom:3px;font-weight:700;}
.content{font-size:1.1rem;line-height:1.5;white-space:pre-wrap;word-break:break-word;}
.input-area{padding:15px 20px;background:var(--panel);border-top:1px solid var(--border);}
.bar{display:flex;gap:15px;align-items:center;}
input{flex:1;background:transparent;border:none;color:#fff;font-size:1.1rem;outline:none;font-weight:300;}
#send-btn{background:transparent;border:2px solid var(--accent);color:var(--accent);padding:10px 22px;border-radius:999px;cursor:pointer;}
#send-btn:hover{background:var(--accent);color:#000;box-shadow:0 0 35px var(--glow);}
#send-btn:disabled{opacity:0.4;cursor:not-allowed;}
</style>
</head>
<body>

<header>
  <div class="logo">PROJECT_AVA</div>
  <div class="tag">V1.2</div>
</header>

<div id="viewport"></div>

<div class="input-area">
  <div class="bar">
    <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off">
    <button id="send-btn" disabled>SEND</button>
  </div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

env.allowLocalModels = true;
env.allowRemoteModels = true;
env.cacheDir = 'project_ava_cache';

const viewport = document.getElementById('viewport');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

let generator = null;
let mem = JSON.parse(localStorage.getItem("AVA_V1_MEM") || "[]");

// append message
function append(role,text){
  if(!text.trim()) return;
  const msg = document.createElement("div");
  msg.className = "msg";
  msg.innerHTML = `<div class="role">${role}</div><div class="content">${text}</div>`;
  viewport.appendChild(msg);
  viewport.scrollTop = viewport.scrollHeight;
  return msg;
}

// initialize Llama core, fallback to remote
async function initCore(){
  append("AVA","Initializing Project_AVA Llama 1Bâ€¦");
  sendBtn.disabled = true;
  try{
    // Try local Llama first
    generator = await pipeline('text-generation','onnx-community/Llama-3.2-1B-Instruct-ONNX',{quantized:true});
    append("AVA","Project_AVA V1.2 active. Ready for your commands.");
    sendBtn.disabled=false;
  }catch(e){
    console.warn("Local Llama failed, falling back to Pollinations.ai:", e);
    append("AVA","Local core failed, switching to remote fallback...");
    try{
      // Remote Pollinations pipeline (text generation)
      generator = await pipeline('text-generation','Xenova/gpt2',{quantized:false, progress_callback:()=>{}});
      append("AVA","Remote core active. Project_AVA ready.");
      sendBtn.disabled=false;
    }catch(err){
      console.error(err);
      append("AVA","Both local and remote cores failed. Try again later.");
    }
  }
}

// send message with streaming if supported
async function sendMessage(){
  const val = input.value.trim();
  if(!val || !generator) return;
  input.value="";
  append("USER",val);
  mem.push({role:"USER",text:val});
  sendBtn.disabled=true;

  const systemPrompt = `You are PROJECT_AVA (V1.2). Intelligent, dry, peer-level. Respond as Project_AVA with logic and reasoning.`;

  try{
    const lastMsg = append("AVA",""); // placeholder for streaming
    if(generator.stream_callback){ // local streaming
      await generator(
        [
          {role:"system",content:systemPrompt},
          {role:"user",content:val}
        ],
        {
          max_new_tokens:256,
          do_sample:true,
          temperature:0.7,
          return_full_text:false,
          stream_callback: token=>{lastMsg.querySelector(".content").textContent += token;}
        }
      );
    }else{ // remote fallback (no streaming)
      const out = await generator([{role:"system",content:systemPrompt},{role:"user",content:val}],{
        max_new_tokens:256,
        do_sample:true,
        temperature:0.7,
        return_full_text:false
      });
      lastMsg.querySelector(".content").textContent = out[0].generated_text;
    }
    mem.push({role:"AVA",text:lastMsg.querySelector(".content").textContent});
    if(mem.length>15) mem.shift();
    localStorage.setItem("AVA_V1_MEM",JSON.stringify(mem));
  }catch(e){
    console.error(e);
    append("AVA","Inference error.");
  }finally{
    sendBtn.disabled=false;
  }
}

sendBtn.onclick = sendMessage;
input.addEventListener("keydown",e=>{if(e.key==="Enter") sendMessage();});

// restore previous session
mem.forEach(m=>append(m.role==='AVA'?'AVA':'USER',m.text));

// initialize core immediately
initCore();
</script>

</body>
</html>
