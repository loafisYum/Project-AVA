<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project_AVA V1.3</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 0;
  background: #010b00;
  font-family: "Courier New", Courier, monospace;
  color: #33ff33;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  padding: 14px 20px;
  border-bottom: 1px solid #004400;
  font-weight: 700;
  letter-spacing: 1px;
  background: #001100;
  position: relative;
  overflow: hidden;
}

/* Glitch effect */
header::before, header::after {
  content: "Project_AVA V1.3";
  position: absolute;
  left: 0;
  width: 100%;
  opacity: 0.8;
  color: #00ff44;
  clip: rect(0, 100%, 0, 0);
  animation: glitch 2s infinite;
}
header::after {
  color: #00ffaa;
  animation-delay: 1s;
}

@keyframes glitch {
  0% { clip: rect(2px, 9999px, 5px, 0); transform: translate(-2px, -1px); }
  10% { clip: rect(10px, 9999px, 20px, 0); transform: translate(2px, 1px); }
  20% { clip: rect(5px, 9999px, 10px, 0); transform: translate(-1px, 2px); }
  30% { clip: rect(15px, 9999px, 18px, 0); transform: translate(1px, -1px); }
  40% { clip: rect(0px, 9999px, 5px, 0); transform: translate(-1px, 0px); }
  50% { clip: rect(10px, 9999px, 12px, 0); transform: translate(2px, 1px); }
  60% { clip: rect(3px, 9999px, 7px, 0); transform: translate(-1px, -2px); }
  70% { clip: rect(5px, 9999px, 12px, 0); transform: translate(0px, 1px); }
  80% { clip: rect(12px, 9999px, 15px, 0); transform: translate(-2px, 0px); }
  90% { clip: rect(2px, 9999px, 6px, 0); transform: translate(1px, -1px); }
  100% { clip: rect(0px, 9999px, 5px, 0); transform: translate(0px, 0px); }
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #001100;
}

.message {
  margin-bottom: 16px;
  line-height: 1.5;
  white-space: pre-wrap;
}

.user { color: #00ffaa; }
.assistant { color: #33ff33; }

#inputContainer {
  display: flex;
  border-top: 1px solid #004400;
  background: #001100;
}

#input {
  flex: 1;
  padding: 14px;
  background: transparent;
  border: none;
  color: #33ff33;
  font-size: 14px;
  outline: none;
}

#sendBtn {
  padding: 14px 22px;
  background: #009900;
  border: none;
  color: #001100;
  cursor: pointer;
  transition: background 0.2s ease;
  font-weight: bold;
}

#sendBtn:hover { background: #00cc00; }

#statusBar {
  font-size: 12px;
  padding: 6px 20px;
  background: #001100;
  border-top: 1px solid #004400;
  color: #009900;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Progress Bar */
#progressContainer {
  flex: 1;
  height: 6px;
  background: #003300;
  margin-left: 10px;
  border-radius: 3px;
  overflow: hidden;
}

#progressBar {
  width: 0%;
  height: 100%;
  background: #00ff33;
  transition: width 0.1s linear;
  border-radius: 3px;
}

</style>
</head>

<body>

<header>Project_AVA V1.3</header>

<div id="chat"></div>

<div id="inputContainer">
  <input id="input" placeholder="Talk to AVA..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<div id="statusBar">
  Engine Priority: Ollama â†’ Pollinations â†’ Offline Core
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
</div>

<script>
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const progressBar = document.getElementById("progressBar");

let busy = false;

let conversation = [
  { role: "system", content: "You are Project_AVA. Direct. Efficient. No fluff." }
];

function appendMessage(role, text) {
  const div = document.createElement("div");
  div.className = "message " + role;
  div.textContent = (role === "user" ? "You: " : "AVA: ") + text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ------------------------------ Input Handling ------------------------------ */
sendBtn.onclick = sendMessage;
inputEl.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* ------------------------------ Core Send ------------------------------ */
async function sendMessage() {
  if (busy) return;

  const text = inputEl.value.trim();
  if (!text) return;

  inputEl.value = "";
  appendMessage("user", text);
  conversation.push({ role: "user", content: text });

  busy = true;
  progressBar.style.width = "0%";

  let reply = "";

  try { reply = await queryOllama(conversation, true); } catch {}
  if (!reply) { try { reply = await queryPollinations(conversation, true); } catch {} }
  if (!reply) { reply = offlineCore(text); }

  conversation.push({ role: "assistant", content: reply });
  appendMessage("assistant", reply);

  progressBar.style.width = "0%";
  busy = false;
}

/* ------------------------------ Ollama ------------------------------ */
async function queryOllama(messages, showProgress = false) {
  const res = await fetch("http://localhost:11434/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ model: "llama3", messages: messages, stream: false })
  });
  if (!res.ok) throw new Error();
  const data = await res.json();
  if (!data.message || !data.message.content) throw new Error();

  // Fake progress animation
  if (showProgress) await animateProgress(data.message.content.length);

  return data.message.content.trim();
}

/* ------------------------------ Pollinations ------------------------------ */
async function queryPollinations(messages, showProgress = false) {
  const history = messages.map(m => m.role + ": " + m.content).join("\n");
  const encoded = encodeURIComponent(history);
  const res = await fetch("https://text.pollinations.ai/openai/" + encoded + "?model=openai&cache=false&seed=" + Math.random());
  if (!res.ok) throw new Error();
  let text = await res.text();
  if (!text || text.length < 2) throw new Error();
  if (showProgress) await animateProgress(text.length);
  return cleanPollinations(text);
}

function cleanPollinations(txt) {
  return txt.replace(/<think>[\s\S]*?<\/think>/gi, "")
            .replace(/\*\*Support[\s\S]*?\*\*/gi, "")
            .replace(/ðŸŒ¸[\s\S]*?ðŸŒ¸/gi, "")
            .trim();
}

/* ------------------------------ Offline Core ------------------------------ */
function offlineCore(input) {
  const lower = input.toLowerCase();
  if (lower.includes("hello")) return "Hello.";
  if (lower.includes("time")) return new Date().toLocaleTimeString();
  if (lower.includes("date")) return new Date().toDateString();
  if (lower.includes("who are you")) return "Project_AVA offline core.";
  return "Local systems operational. No external model reachable.";
}

/* ------------------------------ Progress Bar ------------------------------ */
function animateProgress(chars) {
  return new Promise(resolve => {
    let width = 0;
    const interval = setInterval(() => {
      width += Math.random() * 5; // random speed
      if (width >= 100) { width = 100; clearInterval(interval); resolve(); }
      progressBar.style.width = width + "%";
    }, 50);
  });
}

/* ------------------------------ Stability Guard ------------------------------ */
window.addEventListener("unhandledrejection", () => {});
window.addEventListener("error", () => {});

/* ------------------------------ Auto Focus ------------------------------ */
inputEl.focus();
</script>

</body>
</html>
