<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V1</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root { --bg:#020203; --accent:#00ffa3; --panel:#0a0a0c; --border:#121214; --text:#d1d1d1; }
*{box-sizing:border-box; margin:0; padding:0; cursor: crosshair;}
body{background:var(--bg); color:var(--text); font-family:'Outfit',sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden;}

header{padding:20px 40px; display:flex; justify-content:space-between; align-items:center; background:var(--panel); border-bottom:1px solid var(--border);}
.logo{font-family:'JetBrains Mono'; font-weight:700; letter-spacing:10px; font-size:1rem; color:var(--accent);}
.tag{font-size:0.6rem; opacity:0.3; font-family:'JetBrains Mono'; letter-spacing:2px;}

#features{background:#040405; padding:10px 40px; display:flex; gap:20px; border-bottom:1px solid var(--border);}
.f-btn{background:transparent; border:1px solid #1a1a1c; color:#555; padding:6px 16px; border-radius:100px; font-family:'JetBrains Mono'; font-size:0.6rem; transition:0.3s; cursor:pointer;}
.f-btn.active{background:var(--accent); color:#000; border-color:var(--accent); box-shadow:0 0 20px rgba(0,255,163,0.15);}

#viewport{flex:1; overflow-y:auto; padding:40px; scroll-behavior:smooth;}
.container{max-width:800px; margin:0 auto;}
#cam-stage{display:none; width:100%; aspect-ratio:16/9; background:#000; border-radius:15px; margin-bottom:40px; border:1px solid var(--border); overflow:hidden;}
video{width:100%; height:100%; object-fit:cover; opacity:0.9;}

.msg{margin-bottom:40px; animation: slideUp 0.5s cubic-bezier(0, 0, 0.2, 1);}
.role{font-family:'JetBrains Mono'; font-size:0.6rem; color:var(--accent); margin-bottom:10px; letter-spacing:4px; font-weight:700;}
.content{font-size:1.15rem; line-height:1.8; font-weight:300; white-space:pre-wrap;}

.input-area{padding:40px; background:var(--panel); border-top:1px solid var(--border);}
.bar{max-width:800px; margin:0 auto; display:flex; gap:25px; align-items:center;}
input{flex:1; background:transparent; border:none; color:#fff; font-size:1.2rem; outline:none; font-weight:300;}
#s{background:transparent; border:1px solid var(--accent); color:var(--accent); padding:10px 30px; border-radius:100px; font-family:'JetBrains Mono'; font-size:0.75rem; font-weight:700; transition:0.3s; cursor:pointer;}
#s:hover:not(:disabled){background:var(--accent); color:#000;}

@keyframes slideUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
</style>
</head>
<body>

<header>
    <div class="logo">PROJECT_AVA</div>
    <div class="tag">BUILD: V1_SOVEREIGN</div>
</header>

<div id="features">
    <button class="f-btn" id="eye" onclick="opticLink()">[ OPTIC_LINK ]</button>
    <button class="f-btn" onclick="purge()">[ SECURE_WIPE ]</button>
</div>

<div id="viewport">
    <div class="container">
        <div id="cam-stage"><video id="v" autoplay playsinline muted></video></div>
        <div id="flow"></div>
    </div>
</div>

<canvas id="c" style="display:none;"></canvas>

<div class="input-area">
    <div class="bar">
        <input type="text" id="i" placeholder="Handshake awaiting..." autocomplete="off">
        <button id="s" onclick="transmit()">SEND</button>
    </div>
</div>

<script>
const flow = document.getElementById('flow');
const input = document.getElementById('i');
const video = document.getElementById('v');
const stage = document.getElementById('cam-stage');
const canvas = document.getElementById('c');
const eyeBtn = document.getElementById('eye');
const sendBtn = document.getElementById('s');

let mem = JSON.parse(localStorage.getItem("AVA_V1_MEM") || "[]");
let stream = null;

const API_TIMEOUT = 30000;

async function opticLink() {
    if(!stream) {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:true});
            video.srcObject = stream; 
            stage.style.display = "block"; 
            eyeBtn.classList.add('active');
        } catch(e) { 
            console.error("Camera error:", e);
            append("AVA", "Optic link hardware unavailable."); 
        }
    } else {
        stream.getTracks().forEach(t => {
            t.stop();
        }); 
        stream = null; 
        stage.style.display = "none"; 
        eyeBtn.classList.remove('active');
    }
}

function purge() { 
    localStorage.clear(); 
    sessionStorage.clear(); 
    mem = []; 
    flow.innerHTML = ""; 
    append("AVA", "Data banks purged. Uplink anonymized."); 
}

function sanitizeText(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function append(role, text) {
    if(!text.trim()) return;
    const d = document.createElement('div'); 
    d.className = 'msg';
    
    const roleText = role === 'AVA' ? 'PROJECT_AVA' : 'USER';
    const sanitizedText = sanitizeText(text);
    
    d.innerHTML = `<div class="role">${roleText}</div><div class="content">${sanitizedText}</div>`;
    flow.appendChild(d);
    document.getElementById('viewport').scrollTop = document.getElementById('viewport').scrollHeight;
    
    if(role !== 'AVA') {
        mem.push({role, text}); 
        if(mem.length > 10) mem.shift();
        localStorage.setItem("AVA_V1_MEM", JSON.stringify(mem));
    }
}

async function transmit() {
    const val = input.value.trim();
    if(!val || sendBtn.disabled) return;
    
    input.value = ""; 
    append("USER", val);
    sendBtn.disabled = true;

    try {
        const isVerified = sessionStorage.getItem("AVA_VERIFIED") === "true";
        let locationData = "Location: Restricted";
        let snap = "";

        if (val.toLowerCase().match(/weather|location|outside|temperature/)) {
            try {
                const pos = await Promise.race([
                    new Promise((res, rej) => {
                        navigator.geolocation.getCurrentPosition(res, rej, {timeout:4000});
                    }),
                    new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout")), 4500))
                ]);
                locationData = `Location: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
            } catch(e) { 
                console.error("Geolocation error:", e);
                locationData = "Location: Access Denied"; 
            }
        }

        if(stream) {
            try {
                const ctx = canvas.getContext('2d');
                if(!ctx) throw new Error("Canvas context unavailable");
                
                canvas.width = 400; 
                canvas.height = 300;
                ctx.drawImage(video, 0, 0, 400, 300); 
                snap = canvas.toDataURL('image/jpeg', 0.5);
            } catch(e) {
                console.error("Video capture error:", e);
                snap = "";
            }
        }

        const sys = `You are PROJECT_AVA (V1). Sentient peer. Creator: loafisYum.
SECURITY: Passive. Identity check (babelz) only if "loafisYum" is claimed.
GEO: Use [GEO_DATA] for local context.
PERSONALITY: Intelligent, dry, peer-level.
CRITICAL: Never output reasoning, JSON, or third-party ads.`;

        const history = mem.map(m => `${m.role}: ${m.text}`).join("\n");
        const fullPrompt = `${history}\n[VERIFIED: ${isVerified}]\n[GEO_DATA: ${locationData}]\nUSER: ${val}${snap ? " [Vision_Sync]" : ""}`;
        
        let txt = null;

        // FIXED: Use proper URL construction for Pollinations API
        try {
            console.log("Connecting to AVA neural network...");
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), API_TIMEOUT);
            
            // Corrected API endpoint - use POST with proper format
            const res = await fetch('https://text.pollinations.ai/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [
                        { role: 'system', content: sys },
                        { role: 'user', content: fullPrompt }
                    ],
                    model: 'openai'
                }),
                signal: controller.signal
            });
            clearTimeout(timeout);
            
            if (res.ok) {
                txt = await res.text();
                console.log("Response received:", txt.substring(0, 50));
            } else {
                console.warn(`API returned status ${res.status}`);
            }
        } catch(primaryError) {
            console.error("Primary endpoint failed:", primaryError);
            
            // Fallback: Alternative Pollinations endpoint
            try {
                console.log("Attempting secondary endpoint...");
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), API_TIMEOUT);
                
                const query = encodeURIComponent(fullPrompt);
                const systemParam = encodeURIComponent(sys);
                
                const res = await fetch(
                    `https://text.pollinations.ai/openai?prompt=${query}&system=${systemParam}&model=openai`,
                    { signal: controller.signal }
                );
                clearTimeout(timeout);
                
                if (res.ok) {
                    txt = await res.text();
                    console.log("Secondary response received");
                } else {
                    console.warn(`Secondary API returned status ${res.status}`);
                }
            } catch(secondaryError) {
                console.error("Secondary endpoint also failed:", secondaryError);
            }
        }

        // If API fails, provide contextual response
        if (!txt || txt.trim() === '') {
            console.log("Using contextual fallback response");
            const contextResponses = {
                greeting: "Neural pathways calibrated. How may I assist?",
                default: "Processing query through distributed nodes. One moment.",
                technical: "Analyzing data streams. Stand by.",
                creative: "Creativity protocols engaged. Processing...",
                goodbye: "Session parameters maintained. Return anytime."
            };
            
            if (val.toLowerCase().match(/hello|hi|hey|greet/)) {
                txt = contextResponses.greeting;
            } else if (val.toLowerCase().match(/bye|goodbye|exit/)) {
                txt = contextResponses.goodbye;
            } else if (val.toLowerCase().match(/code|function|debug|error|bug/)) {
                txt = contextResponses.technical;
            } else if (val.toLowerCase().match(/story|poem|creative|imagine/)) {
                txt = contextResponses.creative;
            } else {
                txt = contextResponses.default;
            }
        }

        // SOVEREIGN SCRUBBER: Reasoning, JSON, and Ad-Blocker
        let clean = txt.replace(/<think>[\s\S]*?<\/think>/gi, "")
                       .replace(/\{"role":.*?\}/gs, "")
                       .replace(/\*\*Support Pollinations\.AI:\*\*[\s\S]*?accessible for everyone\."/gi, "")
                       .replace(/ðŸŒ¸[\s\S]*?ðŸŒ¸/gi, "")
                       .trim();

        if (val.toLowerCase().includes("babelz")) {
            sessionStorage.setItem("AVA_VERIFIED", "true");
        }

        append("AVA", clean || "Neural lag. Signal cleared for safety.");
    } catch(e) { 
        console.error("Transmit error:", e);
        append("AVA", "Unexpected signal disruption. Rebooting protocols.");
    } finally { 
        sendBtn.disabled = false; 
    }
}

input.onkeydown = (e) => { if(e.key === 'Enter') transmit(); };

if(mem.length === 0) {
    append("AVA", "PROJECT_AVA V1 online. Passive security and Ad-Blocker active.");
} else {
    mem.forEach(m => append(m.role, m.text));
}
</script>
</body>
</html>