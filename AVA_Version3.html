<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V1.3</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root { 
    --bg:#030305; --accent:#00ffa3; --panel:#0a0a0c; --border:#1a1a1e; --text:#e0e0e0; 
    --glitch-red: #ff003c; --glitch-blue: #00d8ff;
}
body::before {
    content: " "; position: absolute; inset: 0;
    background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%), 
                linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
    background-size:100% 3px, 3px 100%; pointer-events:none; opacity:.6;
}
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{padding:25px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);}
.logo{font-family:'JetBrains Mono';font-weight:700;letter-spacing:10px;font-size:1.1rem;color:var(--accent);}
.tag{font-size:.6rem;opacity:.5;font-family:'JetBrains Mono';}
#core-select{background:#040405;padding:10px 40px;border-bottom:1px solid var(--border);}
#core-select select{
    background:#000;border:1px solid #222;color:var(--accent);
    padding:6px 12px;font-family:'JetBrains Mono';
}
#viewport{flex:1;overflow-y:auto;padding:40px;background:radial-gradient(circle at center,#0a0a14 0%,#030305 100%);}
.container{max-width:850px;margin:0 auto;}
.msg{margin-bottom:40px;}
.role{font-family:'JetBrains Mono';font-size:.6rem;color:var(--accent);margin-bottom:10px;letter-spacing:5px;}
.content{font-size:1.1rem;line-height:1.8;font-weight:300;white-space:pre-wrap;border-left:2px solid rgba(0,255,163,.1);padding-left:20px;}
.input-area{padding:40px;background:var(--panel);border-top:1px solid var(--border);}
.bar{max-width:850px;margin:0 auto;display:flex;gap:20px;align-items:center;border:1px solid #222;padding:10px 25px;border-radius:50px;background:#050507;}
input{flex:1;background:transparent;border:none;color:#fff;font-size:1.1rem;outline:none;}
#s{background:transparent;border:none;color:var(--accent);font-family:'JetBrains Mono';font-weight:700;cursor:pointer;}
#s:disabled{opacity:.4;}
</style>
</head>
<body>

<header>
<div class="logo">PROJECT_AVA</div>
<div class="tag">V1.3 // DUAL CORE</div>
</header>

<div id="core-select">
<select id="engine">
<option value="remote">REMOTE CORE</option>
<option value="local">LOCAL CORE (Qwen 0.5B)</option>
</select>
</div>

<div id="viewport">
<div class="container">
<div id="flow"></div>
</div>
</div>

<div class="input-area">
<div class="bar">
<input type="text" id="i" placeholder="Awaiting handshake..." autocomplete="off">
<button id="s">SEND</button>
</div>
</div>

<script type="module">
import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

const flow = document.getElementById("flow");
const input = document.getElementById("i");
const sendBtn = document.getElementById("s");
const engineSel = document.getElementById("engine");

let mem = JSON.parse(localStorage.getItem("AVA_MEM") || "[]");
let localModel = null;
let loadingLocal = false;

function append(role,text){
    if(!text)return;
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML=`<div class="role">${role==="AVA"?"PROJECT_AVA":"USER"}</div><div class="content">${text.replace(/</g,"&lt;")}</div>`;
    flow.appendChild(d);
    flow.scrollTop=flow.scrollHeight;
}

async function loadLocal(){
    if(localModel || loadingLocal) return;
    loadingLocal = true;
    append("AVA","Loading local neural core...");
    env.allowRemoteModels=true;
    localModel = await pipeline("text-generation","onnx-community/Qwen2.5-0.5B-Instruct-ONNX",{quantized:true});
    append("AVA","Local core ready.");
}

async function getIPLocation(){
    try{
        const ip = await fetch("https://api.ipify.org?format=json").then(r=>r.json());
        const geo = await fetch(`https://ipapi.co/${ip.ip}/json/`).then(r=>r.json());
        return `${geo.city}, ${geo.country_name}`;
    }catch{
        return "Unknown";
    }
}

async function remoteAsk(prompt,sys){
    const query=encodeURIComponent(prompt);
    const res=await fetch(`https://text.pollinations.ai/openai/${query}?system=${encodeURIComponent(sys)}&model=openai&cache=false&seed=${Math.random()}`);
    return (await res.text()).trim();
}

async function localAsk(messages){
    const out=await localModel(messages,{max_new_tokens:200,temperature:0.7,return_full_text:false});
    return out[0].generated_text.trim();
}

async function transmit(){
    const val=input.value.trim();
    if(!val)return;
    input.value="";
    append("USER",val);
    sendBtn.disabled=true;

    const location=await getIPLocation();
    const sys=`You are PROJECT_AVA. Intelligent. Dry. Peer-level. GEO:${location}.`;

    try{
        let response="";
        if(engineSel.value==="local"){
            await loadLocal();
            const messages=[
                {role:"system",content:sys},
                ...mem.map(m=>({role:m.role==="AVA"?"assistant":"user",content:m.text})),
                {role:"user",content:val}
            ];
            response=await localAsk(messages);
        }else{
            response=await remoteAsk(val,sys);
        }

        append("AVA",response);
        mem.push({role:"USER",text:val});
        mem.push({role:"AVA",text:response});
        if(mem.length>12)mem.shift();
        localStorage.setItem("AVA_MEM",JSON.stringify(mem));

    }catch(e){
        append("AVA","Core instability detected.");
        console.error(e);
    }

    sendBtn.disabled=false;
}

sendBtn.onclick=transmit;
input.addEventListener("keydown",e=>{if(e.key==="Enter")transmit();});

if(mem.length===0) append("AVA","V1.3 ONLINE. Select your core.");
else mem.forEach(m=>append(m.role,m.text));
</script>
</body>
</html>
