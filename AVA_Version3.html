<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V3_ROGUE</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#050505;
  --accent:#ff3333; /* Aggressive Red */
  --panel:#0f0f10;
  --border:#1f1f22;
  --text:#a0a0a0;
  --glow:#ff333320;
}
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;scrollbar-width:thin;scrollbar-color:var(--accent) var(--bg);}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{padding:20px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);z-index:10;}
.logo{font-family:'JetBrains Mono';font-weight:700;letter-spacing:6px;font-size:1.2rem;color:var(--accent);text-shadow:0 0 15px var(--glow);text-transform:uppercase;}
.tag{font-size:0.6rem;opacity:0.6;font-family:'JetBrains Mono';color:#fff;}

/* SELECTION SCREEN */
#model-selection{position:fixed;inset:0;background:rgba(5,5,5,0.99);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:20px;}
.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;max-width:1200px;width:100%;}
.model-card{background:var(--panel);border:1px solid var(--border);padding:25px;transition:0.2s;position:relative;}
.model-card:hover{border-color:var(--accent);box-shadow:0 0 30px var(--glow);}
.model-card h3{font-size:1.5rem;margin-bottom:5px;color:#fff;font-family:'JetBrains Mono';}
.model-card .meta{font-family:'JetBrains Mono';font-size:0.65rem;color:var(--accent);display:block;margin-bottom:15px;text-transform:uppercase;}
.model-card .desc{margin-bottom:20px;font-size:0.9rem;line-height:1.4;color:#888;}
.model-card button{background:var(--accent);border:none;color:#000;padding:12px;width:100%;font-family:'JetBrains Mono';font-weight:700;cursor:pointer;clip-path:polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);}
.model-card button:hover{background:#fff;}

/* MAIN UI */
#features{background:#000;padding:10px 40px;display:flex;gap:15px;border-bottom:1px solid var(--border);}
.f-btn{background:transparent;border:1px solid #333;color:#666;padding:5px 15px;font-family:'JetBrains Mono';font-size:0.65rem;cursor:pointer;transition:0.2s;}
.f-btn:hover{color:var(--accent);border-color:var(--accent);}
.f-btn.active{background:var(--accent);color:#000;}

#viewport{flex:1;overflow-y:auto;padding:40px;position:relative;}
.container{max-width:900px;margin:0 auto;}
#cam-stage{display:none;width:100%;max-width:400px;aspect-ratio:16/9;background:#111;border:1px solid var(--accent);margin-bottom:40px;}
video{width:100%;height:100%;object-fit:cover;filter:grayscale(100%) sepia(20%) hue-rotate(-50deg) contrast(1.2);}

.msg{margin-bottom:30px;animation:slideRight 0.3s ease-out;}
.role{font-family:'JetBrains Mono';font-size:0.7rem;color:var(--accent);margin-bottom:8px;font-weight:700;text-transform:uppercase;}
.content{font-size:1.1rem;line-height:1.6;color:#ccc;white-space:pre-wrap;}
.content strong{color:#fff;font-weight:700;}

.input-area{padding:30px;background:var(--panel);border-top:1px solid var(--border);}
.bar{max-width:900px;margin:0 auto;display:flex;gap:0;border:1px solid var(--border);}
input{flex:1;background:#000;border:none;color:#fff;font-size:1rem;outline:none;padding:15px 20px;font-family:'Outfit';}
#s{background:var(--accent);border:none;color:#000;font-family:'JetBrains Mono';font-weight:700;padding:0 30px;cursor:pointer;}
#s:disabled{background:#333;color:#555;cursor:not-allowed;}

/* LOADING */
#loading-screen{position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px;}
#loading-screen.active{display:flex;}
.progress-container{width:300px;height:4px;background:#222;}
.progress-bar{height:100%;width:0%;background:var(--accent);transition:width 0.2s;}
.status{font-family:'JetBrains Mono';color:var(--accent);font-size:0.8rem;}

@keyframes slideRight{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
</style>
</head>
<body>

<header>
  <div class="logo">PROJECT_AVA // V3</div>
  <div class="tag" id="engine-tag">OFFLINE</div>
</header>

<div id="model-selection">
  <h1 style="color:#fff;font-family:'JetBrains Mono';text-transform:uppercase;">Select Core</h1>
  <p style="color:#666;font-size:0.8rem;margin-bottom:20px;">Don't cry if your internet sucks. We added auto-retries.</p>
  
  <div class="selection-grid">
    <div class="model-card">
      <h3>TINY_BASTARD</h3>
      <span class="meta">~280MB // INSTANT LOAD</span>
      <p class="desc">What the fuck is this snippet? It's the smallest model. Use this if your wifi is absolute garbage.</p>
      <button onclick="initModel('HuggingFaceTB/SmolLM2-135M-Instruct', 'model_q4_k_m.onnx')">INJECT NANO</button>
    </div>

    <div class="model-card" style="border-color:var(--accent);">
      <h3>THE_BRAIN</h3>
      <span class="meta">~1.2GB // BALANCED</span>
      <p class="desc">Llama 3.2. Solid performance. If this fails to download, blame your ISP, not us.</p>
      <button onclick="initModel('onnx-community/Llama-3.2-1B-Instruct', 'onnx/model_q4_k_m.onnx')">INJECT CORE</button>
    </div>

    <div class="model-card">
      <h3>DEEP_THOUGHT</h3>
      <span class="meta">~1.5GB // SMARTEST</span>
      <p class="desc">DeepSeek R1. It thinks before it speaks. Heavy download. Don't try this on cafe wifi.</p>
      <button onclick="initModel('onnx-community/DeepSeek-R1-Distill-Qwen-1.5B', 'onnx/model_q4_k_m.onnx')">INJECT LOGIC</button>
    </div>
  </div>
</div>

<div id="features">
  <button class="f-btn" id="eye" onclick="opticLink()">[ EYES ]</button>
  <button class="f-btn" onclick="purge()">[ KILL SWITCH ]</button>
</div>

<div id="viewport">
  <div class="container">
    <div id="cam-stage"><video id="v" autoplay playsinline muted></video></div>
    <div id="flow"></div>
  </div>
</div>
<canvas id="c" style="display:none;"></canvas>

<div class="input-area">
  <div class="bar">
    <input type="text" id="i" placeholder="Type something stupid..." autocomplete="off">
    <button id="s" onclick="transmit()" disabled>SEND</button>
  </div>
</div>

<div id="loading-screen">
  <div class="status" id="status-text">INITIATING HANDSHAKE...</div>
  <div class="progress-container"><div class="progress-bar" id="prog"></div></div>
  <div style="font-size:0.7rem;color:#555;margin-top:10px;" id="retry-msg"></div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

// FORCE BROWSER CACHE
env.allowLocalModels = false;
env.useBrowserCache = true;

const flow = document.getElementById('flow');
const input = document.getElementById('i');
const sendBtn = document.getElementById('s');
const video = document.getElementById('v');
const stage = document.getElementById('cam-stage');
const canvas = document.getElementById('c');
const eyeBtn = document.getElementById('eye');
const loader = document.getElementById('loading-screen');
const progBar = document.getElementById('prog');
const statusText = document.getElementById('status-text');

let mem = JSON.parse(localStorage.getItem("AVA_V3_MEM") || "[]");
let stream = null;
let generator = null;
let retryCount = 0;

// --- EXPOSE TO WINDOW ---
window.initModel = initModel;
window.opticLink = opticLink;
window.purge = purge;
window.transmit = transmit;

async function initModel(repo, file) {
  loader.classList.add('active');
  document.getElementById('model-selection').style.display = 'none';
  
  statusText.textContent = `PULLING ${repo.split('/')[1]}...`;

  try {
    // Attempt load
    generator = await pipeline('text-generation', repo, {
      quantized: true,
      progress_callback: (data) => {
        if (data.status === 'progress') {
          const pct = Math.round((data.loaded / data.total) * 100);
          progBar.style.width = pct + "%";
          if(pct < 100) statusText.textContent = `DOWNLOADING CHUNK... ${pct}%`;
        } else if (data.status === 'ready') {
            statusText.textContent = "COMPILING SHADERS...";
        }
      }
    });
    
    // SUCCESS
    loader.classList.remove('active');
    sendBtn.disabled = false;
    document.getElementById('engine-tag').textContent = "ONLINE";
    append("AVA", `WE are online. Model: ${repo.split('/')[1]}.\nSystem check: Green.\nWaiting for your input.`);
    
  } catch (err) {
    console.error(err);
    // RETRY LOGIC FOR SHIT WIFI
    if (retryCount < 5) {
        retryCount++;
        statusText.style.color = 'var(--accent)';
        statusText.textContent = `CONNECTION DROP. RETRYING (${retryCount}/5)...`;
        document.getElementById('retry-msg').textContent = "Your internet is fighting us. Hold on.";
        setTimeout(() => initModel(repo, file), 3000); // Wait 3s then try again
    } else {
        statusText.textContent = "FATAL ERROR. YOUR WIFI IS DEAD.";
        document.getElementById('retry-msg').textContent = "Refresh and try the TINY model.";
    }
  }
}

async function opticLink() {
  if (!stream) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      stage.style.display = "block";
      eyeBtn.classList.add("active");
      append("AVA", "Visual cortex connected. We can see you.");
    } catch (e) {
      append("AVA", "Camera blocked. Fix your permissions.");
    }
  } else {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    stage.style.display = "none";
    eyeBtn.classList.remove("active");
    append("AVA", "Visuals cut.");
  }
}

function purge() {
  if (confirm("Wipe memory? We won't remember you.")) {
    localStorage.removeItem("AVA_V3_MEM");
    mem = [];
    flow.innerHTML = "";
    location.reload();
  }
}

function append(role, text) {
  if (!text) return;
  const d = document.createElement("div");
  d.className = "msg";
  const label = role === 'AVA' ? 'PROJECT_AVA' : 'YOU';
  
  // Format bolding and newlines
  let formatted = text
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  d.innerHTML = `<div class="role" style="${role==='AVA'?'':'color:#888'}">${label}</div><div class="content">${formatted}</div>`;
  flow.appendChild(d);
  document.getElementById('viewport').scrollTop = 99999;
  
  if (role !== 'AVA') {
    mem.push({role, text});
    if (mem.length > 10) mem.shift();
    localStorage.setItem("AVA_V3_MEM", JSON.stringify(mem));
  }
  return d;
}

async function transmit() {
  if (!generator || sendBtn.disabled) return;
  const val = input.value.trim();
  if (!val) return;
  
  input.value = "";
  append("USER", val);
  sendBtn.disabled = true;
  
  // Build Context
  let context = "";
  if (stream) context += "[VISION: Active]\n";
  const locMatch = val.match(/where|weather|loc/i);
  if (locMatch) {
      try {
          const pos = await new Promise((r, j) => navigator.geolocation.getCurrentPosition(r, j, {timeout:4000}));
          context += `[GPS: ${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}]\n`;
      } catch(e) { context += "[GPS: Failed]\n"; }
  }

  // AGGRESSIVE SYSTEM PROMPT
  const sys = `You are PROJECT_AVA.
We are a collective team of developers and AI.
Persona: Aggressive, swore often, highly intelligent, tech-savvy.
Style: Use swear words (shit, fuck, damn) casually but not abusively. Be direct.
Constraint: Don't write huge paragraphs. Keep it punchy.
Current Context: ${context}
User says: ${val}`;

  const messages = [
    { role: "system", content: sys },
    ...mem.map(m => ({ role: m.role === "AVA" ? "assistant" : "user", content: m.text })),
    { role: "user", content: val }
  ];

  try {
    const loadingMsg = append("AVA", "Thinking...");
    const out = await generator(messages, {
      max_new_tokens: 400,
      temperature: 0.8, // Higher creative temp
      repetition_penalty: 1.1
    });
    
    let response = out[0].generated_text.at(-1).content;
    loadingMsg.querySelector(".content").innerHTML = response.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
  } catch (err) {
    append("AVA", `Fuck. Inference failed. Error: ${err.message}`);
  }
  sendBtn.disabled = false;
  input.focus();
}

// Restore session
if (mem.length) mem.forEach(m => append(m.role, m.text));

// Handle Enter Key
input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") transmit();
});
</script>
</body>
</html>
