<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT_AVA // V4.1_FORCE</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root { --bg:#020203; --accent:#ff3333; --panel:#0a0a0c; --border:#1a1a1c; --text:#b0b0b0; }
*{box-sizing:border-box;margin:0;padding:0;cursor:crosshair;}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HUB & LOADER */
#hub, #loader{position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px; text-align:center;}
.grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;width:100%;max-width:900px;}
.card{background:var(--panel);border:1px solid var(--border);padding:25px;transition:0.3s;}
.card:hover{border-color:var(--accent);}
.card h2{color:#fff;font-family:'JetBrains Mono';font-size:1rem;margin-bottom:10px;}
button{background:var(--accent);border:none;color:#000;padding:12px;font-family:'JetBrains Mono';font-weight:700;cursor:pointer;width:100%;}

#loader{display:none; z-index:10001;}
.bar-container{width:300px;height:2px;background:#222;margin:20px 0;overflow:hidden;}
.bar-fill{width:0%;height:100%;background:var(--accent);transition:0.2s;}

/* CHAT INTERFACE */
header{padding:15px 30px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
#viewport{flex:1;overflow-y:auto;padding:40px; background:radial-gradient(circle at center, #0a0a0c 0%, #020203 100%);}
.container{max-width:800px;margin:0 auto;}
.msg{margin-bottom:30px; animation:fIn 0.3s ease;}
.role{font-family:'JetBrains Mono';font-size:0.6rem;color:var(--accent);margin-bottom:5px;letter-spacing:2px;font-weight:700;}
.content{font-size:1rem;line-height:1.6;color:#eee;white-space:pre-wrap;}

.input-area{padding:30px;background:var(--panel);border-top:1px solid var(--border);}
.bar{max-width:800px;margin:0 auto;display:flex;gap:15px;}
input{flex:1;background:transparent;border:none;color:#fff;outline:none;font-size:1rem;}
#send-btn{background:transparent;border:none;color:var(--accent);font-family:'JetBrains Mono';font-weight:700;cursor:pointer;}

@keyframes fIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<div id="hub">
  <h1 style="color:#fff;letter-spacing:10px;margin-bottom:5px;">PROJECT_AVA</h1>
  <p style="margin-bottom:35px;opacity:0.5;font-size:0.7rem;font-family:'JetBrains Mono';">V4.1 // RAM_ONLY // NO_CACHE</p>
  <div class="grid">
    <div class="card">
      <h2>NANO_SHARD</h2>
      <p style="font-size:0.7rem; margin-bottom:15px;">Fastest. Lowest RAM. "What the fuck is this snippet?"</p>
      <button onclick="boot('HuggingFaceTB/SmolLM2-135M-Instruct')">INJECT NANO</button>
    </div>
    <div class="card">
      <h2>CORE_SHARD</h2>
      <p style="font-size:0.7rem; margin-bottom:15px;">Llama 3.2. Better logic. Needs decent RAM.</p>
      <button onclick="boot('onnx-community/Llama-3.2-1B-Instruct')">INJECT CORE</button>
    </div>
  </div>
</div>

<div id="loader">
  <div id="st" style="font-family:'JetBrains Mono'; color:var(--accent); font-size:0.8rem;">INITIALIZING RAM STREAM...</div>
  <div class="bar-container"><div class="bar-fill" id="bf"></div></div>
  <p id="debug-log" style="font-size:0.6rem; color:#555; margin-bottom:20px;">Standby...</p>
  <button id="force-btn" style="display:none; width:auto; padding:8px 20px; font-size:0.7rem;" onclick="showChat()">FORCE OPEN CHAT</button>
</div>

<header>
  <div style="font-family:'JetBrains Mono';font-weight:700;color:var(--accent);font-size:0.8rem;">AVA_CORE // ACTIVE</div>
  <div style="font-size:0.6rem; opacity:0.4;">SESSIONS ARE TEMPORARY. NO DISK USE.</div>
</header>

<div id="viewport">
  <div class="container" id="flow"></div>
</div>

<div class="input-area">
  <div class="bar">
    <input type="text" id="i" placeholder="Handshake ready..." autocomplete="off">
    <button id="send-btn" onclick="transmit()">SEND</button>
  </div>
</div>

<script type="module">
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

// BYPASS DISK COMPLETELY
env.allowLocalModels = false;
env.useBrowserCache = false;

let generator = null;
let mem = [];

function logDebug(txt) { document.getElementById('debug-log').textContent = txt; }

window.showChat = function() {
  document.getElementById('loader').style.display = 'none';
  document.getElementById('hub').style.display = 'none';
  append("AVA", "System interface forced open. If the model didn't load properly, I'm just going to stare at you blankly.");
};

window.boot = async function(repo) {
  document.getElementById('hub').style.display = 'none';
  const ldr = document.getElementById('loader');
  ldr.style.display = 'flex';
  
  try {
    logDebug("Connecting to HuggingFace CDN...");
    generator = await pipeline('text-generation', repo, {
      quantized: true,
      progress_callback: (data) => {
        if (data.status === 'progress') {
          const pct = Math.round((data.loaded / data.total) * 100);
          document.getElementById('bf').style.width = pct + "%";
          document.getElementById('st').textContent = `STREAMING: ${pct}%`;
        }
        if (data.status === 'initiate') logDebug(`Loading shard: ${data.file}`);
        if (data.status === 'ready') logDebug("Engine Ready. Finalizing RAM allocation...");
      }
    });

    // Success - Open Chat
    showChat();
    append("AVA", `PROJECT_AVA live. We're streaming ${repo.split('/')[1]} directly. No disk footprints. Ask us something.`);
    
  } catch (e) {
    logDebug(`CRITICAL ERROR: ${e.message}`);
    document.getElementById('force-btn').style.display = 'block';
    document.getElementById('st').textContent = "STREAM FAILED";
    console.error("AVA_ERROR:", e);
  }
}

function append(role, text) {
  const d = document.createElement('div');
  d.className = 'msg';
  d.innerHTML = `<div class="role">${role === 'AVA' ? 'PROJECT_AVA' : 'YOU'}</div><div class="content">${text}</div>`;
  document.getElementById('flow').appendChild(d);
  document.getElementById('viewport').scrollTop = 999999;
}

window.transmit = async function() {
  const input = document.getElementById('i');
  const val = input.value.trim();
  if (!val) return;
  if (!generator) { append("AVA", "Error: The engine isn't initialized yet. Stop rushing us."); return; }
  
  append("USER", val);
  input.value = "";

  const sys = "You are PROJECT_AVA. Intelligent, blunt, and casually sweary (shit, fuck). Be direct.";
  const messages = [{ role: "system", content: sys }, ...mem, { role: "user", content: val }];

  try {
    const out = await generator(messages, { max_new_tokens: 250, temperature: 0.7 });
    const response = out[0].generated_text.at(-1).content;
    append("AVA", response);
    mem.push({ role: "user", content: val }, { role: "assistant", content: response });
    if (mem.length > 8) mem.splice(0, 2);
  } catch (e) {
    append("AVA", "Fuck. The model crashed. Your browser likely throttled the RAM usage.");
  }
}

document.getElementById('i').onkeydown = (e) => { if(e.key === 'Enter') transmit(); };
</script>
</body>
</html>
